<!-- home.html -->
{% extends 'base.html' %}

{% block content %}
  <div class="container">
    {% if user.is_authenticated %}
      <div class="mb-3">
          <input type="text" id="searchInputs" class="form-control" placeholder="Search..." name="q" autocomplete="off">
          <ul id="searchResults" class="list-group" style="position: absolute;"></ul>
      </div>
      <div class="mb-3">
        <a id="createNewButton" class="btn btn-primary">Create New</a>
      </div>
      <div class="table-section">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th scope="col"></th>
                <th scope="col"></th>
                <th scope="col">Name</th>
                <th scope="col">File Path</th>
                <th scope="col">Create Day</th>
                <th scope="col">Last Modified Time</th>
                <th scope="col"> Upload </th>
              </tr>
            </thead>
            <tbody id="tableBody">
              {% if items %}
                {% for item in items %}
                    <tr>
                      <td>
                        <a class="btn btn-success" href="{% url 'file_download' pk=item.file_path %}" download>Download</a>
                      </td>
                        <td>
                          <button type="button" class="btn btn-light"  onclick="confirmDelete(this)" data-filepath="{{ item.file_path }}">Delete</button>
                        </td>

                        <td onclick="window.location.href='{% url 'e_record' item.file_path %}';">{{ item.file_name }}</td>
                        {% if file_path is not True %}
                            <td onclick="window.location.href='{% url 'e_record' item.file_path %}';">{{ item.file_path }}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                        <td onclick="window.location.href='{% url 'e_record' item.file_path %}';">{{ item.file_created }}</td>
                        <td onclick="window.location.href='{% url 'e_record' item.file_path %}';">{{ item.file_last_modified }}</td>
                        <td>
                      <div class="dropdown">
                        <button class="dropdown-item" onclick="toggleForm(this, {{ item.form_id_counter }})">Upload File</button>
                        <div class="dropdown-content" id="uploadForm{{ item.form_id_counter }}" style="display: none;">
                          <div class="container">
                            <form id="uploadForm" action="{% url 'profile_image_upload' file_path=item.file_path %}" method="post" enctype="multipart/form-data" class="mt-5">
                              {% csrf_token %}
                              {{ item.formd.as_p }}
                              <button type="submit" onclick="getPath(this, {{item.file_path}})" class="btn btn-secondary">Submit</button>
                             <a class="btn btn-secondary" href="{% url 'cam_scan' item.file_path %}">Scan Image</a>
                            </form>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal fade" id="createNewModal" tabindex="-1" role="dialog" aria-labelledby="createNewModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createNewModalLabel">Create New</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <!-- Input field for keyboard input -->
              <form id="createNewForm">
                <div class="mb-3">
                  <label for="customInput" class="form-label">Type Something:</label>
                  <input type="text" class="form-control" id="customInput" name="customInput" required>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <!-- Submit button instead of close button -->
              <button type="submit" class="btn btn-primary" onclick="submitCreateNewForm()">Submit</button>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <h1>login</h1>
      <br/>
      <form method="POST" action="{% url 'home' %}">
          {% csrf_token %}
          <form>
              <div class="mb-3">
                <input type="text" class="form-control" name="username", placeholder="User Name">
              </div><br/>
              <div class="mb-3">
                <input type="password" class="form-control" name="password", placeholder="Password">
              </div>
              <button type="submit" class="btn btn-primary">login</button>
            </form>
      </form>
      </div>
    {% endif %}
  </div>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>

<script>
    $('#searchInputs').on('input', function() {
        var searchQuery = $(this).val().toLowerCase();

        // Filter the table rows based on the search query
        $('#tableBody tr').each(function() {
            var fileName = $(this).find('td:nth-child(3)').text().toLowerCase();
            var shouldShow = searchQuery === '' || fileName.includes(searchQuery);

            $(this).toggle(shouldShow);
        });
    });
</script>


<script>
    function confirmDelete(button) {
        var filePath = button.getAttribute('data-filepath');
        console.log(filePath);

        // Check if filePath is not empty and not undefined
        if (filePath) {
            var deleteUrl = '{% url "delete_excel_file" deleted_file="__placeholder__" %}'.replace('__placeholder__', encodeURIComponent(filePath));
            var result = confirm("Are you sure you want to delete this file?");

            if (result) {
                window.location.href = deleteUrl;
            } else {
                // If the user clicks "Cancel", do nothing
            }
        } else {
            console.error("File path is empty or undefined.");
        }
    }
</script>
<script>
      $('#createNewButton').on('click', function() {
        $('#createNewModal').modal('show');
      });
      window.submitCreateNewForm = function() {
      // Get the input value
      var inputValue = $('#customInput').val();
      var csrftoken = Cookies.get('csrftoken');
      // Perform the AJAX request
      $.ajax({
          url: '{% url "add_excel_file" %}',
          type: 'POST',
          data: {'customInput': inputValue},
          dataType: 'json',
          headers: {'X-CSRFToken': csrftoken},
          success: function(response) {
            console.log('Server response:', response);
            // Optionally, you can perform additional actions based on the server response
          },
          error: function(error) {
            console.error('Error:', error);
            location.reload();
        }
      });

      // Close the modal
      $('#createNewModal').modal('hide');
    };

    function toggleForm(button, formId) {
        var form = $('#uploadForm' + formId);
        form.toggle();  // Toggle the visibility of the form
    }

    function getPath(button, file_path) {
        // Assuming 'file_path' is a string, modify this based on your data structure
        var form = $(button).closest('form');
        form.attr('action', form.attr('action') + '/' + encodeURIComponent(file_path));
    }
</script>

{% endblock %}
